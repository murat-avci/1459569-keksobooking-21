(()=>{"use strict";(()=>{const e=function(e,n){const t=new XMLHttpRequest;return t.responseType="json",t.addEventListener("load",(function(){switch(t.status){case window.constants.SUCCESS_REQ:e(t.response);break;case window.constants.FAILED_REQ:n("Неверный запрос");break;case window.constants.BAD_REQ:n("Ничего не найдено");break;default:n(`Неизвестный статус: ${t.status} ${t.statusText}`)}})),t.addEventListener("error",(function(){n("Что-то пошло не так! Произошла ошибка соединения")})),t.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${t.timeout} мс`)})),t.timeout=window.constants.TIMEOUT,t};window.backend={load(n,t){const o=e(n,t);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},upload(n,t,o){const i=e(t,o);i.open("POST","https://21.javascript.pages.academy/keksobooking"),i.send(n)}}})(),window.debounce=function(e){let n=null;return function(){let t=arguments;n&&window.clearTimeout(n),n=window.setTimeout((function(){e.apply(null,t)}),window.constants.DEBOUNCE_INTERVAL)}},window.constants={CHECK_TIMES:["12:00","13:00","14:00"],MIN_PRICE:1e3,MAX_PRICE:1e6,MIN_ROOM:1,MAX_ROOM:5,MIN_GUESTS:1,MAX_GUESTS:5,MIN_LOCATION_Y:130,MAX_LOCATION_Y:630,PIN_HEIGHT:65,PIN_WIDTH:65,PIN_ARROW_HEIGHT:22,MAP_PIN_ACTIVE_CLASS:"map__pin--active",ESC_KEYCODE:27,AVATAR_WIDTH:45,AVATAR_HEIGHT:40,TIMEOUT:1e4,PIN_TOP_COORD:375,PIN_LEFT_COORD:570,CAPACITY_SELECTED:2,ROOM_SELECTED:0,DEBOUNCE_INTERVAL:500,SUCCESS_REQ:200,FAILED_REQ:400,BAD_REQ:404,MIN_OFFER_PRICE:1e3,MAX_OFFER_PRICE:5e4,MAX_QUANTITY_PINS:5,TypesOfHouses:{bungalow:{min:0,placeholder:"0",translate:"Бунгало"},flat:{min:1e3,placeholder:"1000",translate:"Квартира"},house:{min:5e3,placeholder:"5000",translate:"Дом"},palace:{min:1e4,placeholder:"10000",translate:"Дворец"}},Rooms:{1:{enabled:["1"],textError:"не более одного гостя"},2:{enabled:["1","2"],textError:"не более одного или двух гостей"},3:{enabled:["1","2","3"],textError:"не более одного, двух или трёх гостей"},100:{enabled:["0"],textError:"не для гостей"}}},window.elements={mapSection:document.querySelector(".map"),fieldsets:document.querySelectorAll("fieldset"),filterSelects:document.querySelectorAll("select[name^=housing]"),mapPinList:document.querySelector(".map__pins"),pinTemplate:document.querySelector("#pin").content.querySelector(".map__pin"),cardTemplate:document.querySelector("#card").content.querySelector(".map__card"),mainPin:document.querySelector(".map__pin--main"),advertForm:document.querySelector(".ad-form"),mapForm:document.querySelector(".ad-form "),fragmentPins:document.createDocumentFragment(),errorTemplate:document.querySelector("#error").content.querySelector(".error"),successTemplate:document.querySelector("#success").content.querySelector(".success"),inputAddress:document.querySelector("#address"),filterForm:document.querySelector(".map__filters")},(()=>{const e=window.elements.filterForm.querySelector("#housing-type"),n=window.elements.filterForm.querySelector("#housing-price"),t=window.elements.filterForm.querySelector("#housing-rooms"),o=window.elements.filterForm.querySelector("#housing-guests"),i=window.elements.filterForm.querySelector("#housing-features");window.filter={onMapFormChange:window.debounce((function(){window.pin.visible.forEach((function(e){e.remove()})),window.pin.visible=[],window.showCard.closeOpenedAdvert(window.showCard.currentAdvert),window.shufledPins=window.util.shuffleArray(window.adverts),window.filteredPins=window.shufledPins.filter((function(s){const d=(r=s,"any"===e.value||r.offer.type===e.value);var r;const a=(l=s,"low"===n.value?l.offer.price<window.constants.MIN_OFFER_PRICE:"middle"===n.value?l.offer.price>=window.constants.MIN_OFFER_PRICE&&l.offer.price<=window.constants.MAX_OFFER_PRICE:"high"!==n.value||l.offer.price>window.constants.MAX_OFFER_PRICE);var l;const c=(w=s,"any"===t.value||w.offer.rooms.toString()===t.value);var w;const m=(u=s,"any"===o.value||u.offer.guests.toString()===o.value);var u;const p=function(e){const n=i.querySelectorAll("input[type=checkbox]:checked");return[].map.call(n,(function(e){return e.value})).every((function(n){return e.offer.features.includes(n)}))}(s);return d&&a&&c&&m&&p})),window.pin.createPins(window.filteredPins.slice(0,window.constants.MAX_QUANTITY_PINS)),0===window.filteredPins.length?(document.removeEventListener("keydown",window.showCard.onEscRemoveAdvert),window.elements.mapSection.removeEventListener("click",window.showCard.onPinClick)):(document.addEventListener("keydown",window.showCard.onEscRemoveAdvert),window.elements.mapSection.addEventListener("click",window.showCard.onPinClick))}))}})(),(()=>{const e=window.elements.mapForm.querySelector("#room_number"),n=window.elements.mapForm.querySelector("#capacity"),t=window.elements.mapForm.querySelector("#type"),o=window.elements.mapForm.querySelector("#timein"),i=window.elements.mapForm.querySelector("#timeout"),s=window.elements.mapForm.querySelector("#price"),d=n.querySelectorAll("option"),r=window.elements.successTemplate.cloneNode(!0),a=window.elements.errorTemplate.cloneNode(!0),l=a.querySelector(".error__button"),c=window.elements.mapForm.querySelector(".ad-form__reset"),w=document.querySelectorAll("input[type=checkbox]"),m=window.elements.mapForm.querySelector("#description"),u=window.elements.mapForm.querySelector("#title");o.addEventListener("change",(function(){i.value=o.value})),i.addEventListener("change",(function(){o.value=i.value})),t.addEventListener("change",(function(){const e=window.constants.TypesOfHouses[t.value];s.setAttribute("min",e.min),s.setAttribute("placeholder",e.placeholder)})),e.addEventListener("change",(function(){const n=window.constants.Rooms[e.value];p(n),f(n)}));const p=function(e){d.forEach((function(n){var t;n.disabled=(t=n.value,-1===e.enabled.indexOf(t))}))},f=function(e){const t=-1!==e.enabled.indexOf(n.value)?"":e.textError;n.setCustomValidity(t)};n.addEventListener("change",(function(){n.setCustomValidity("")}));const v=function(){r&&window.elements.mapSection.removeChild(r),document.removeEventListener("keydown",window.showCard.onEscRemoveAdvert),window.elements.filterForm.removeEventListener("change",window.filter.onMapFormChange),document.removeEventListener("keyup",E),document.removeEventListener("click",_)},E=function(e){e.keyCode===window.constants.ESC_KEYCODE&&v()},_=function(){v()},C=function(){window.elements.mapSection.appendChild(r),I(),document.addEventListener("keyup",E),document.addEventListener("click",_)},h=function(e){e.keyCode===window.constants.ESC_KEYCODE&&A()},y=function(e){e.keyCode===window.constants.ENTER_KEYCODE&&A()},S=function(){A()},A=function(){window.elements.mapSection.removeChild(a),document.removeEventListener("keydown",window.showCard.onEscRemoveAdvert),window.elements.filterForm.removeEventListener("change",window.filter.onMapFormChange),l.removeEventListener("keyup",y),document.removeEventListener("keyup",h),document.removeEventListener("click",S)},L=function(e){a.querySelector(".error__message").textContent=e,l.focus(),l.setAttribute("tabindex","0"),l.style.border="2px solid yellow",window.elements.mapSection.appendChild(a),l.addEventListener("keyup",y),document.addEventListener("keyup",h),document.addEventListener("click",S)};window.elements.mapForm.addEventListener("submit",(function(e){e.preventDefault(),window.backend.upload(new FormData(window.elements.mapForm),C,L),window.elements.mapSection.removeEventListener("click",window.showCard.onPinClick)}));const I=function(){w.forEach((function(e){e.checked&&(e.checked=!1)})),window.showCard.closeOpenedAdvert(window.showCard.currentAdvert),u.value="",m.value="",s.setAttribute("placeholder",window.constants.MIN_PRICE),s.value="",window.elements.mapSection.classList.add("map--faded"),window.elements.advertForm.classList.add("ad-form--disabled"),window.util.toggleDisabled(!0,window.elements.fieldsets),window.util.toggleDisabled(!0,window.elements.filterSelects),n.selectedIndex=window.constants.CAPACITY_SELECTED,e.selectedIndex=window.constants.ROOM_SELECTED,window.util.toggleDisabled(!0,n),function(){const e=window.elements.mapPinList.querySelectorAll(".map__pin:not(.map__pin--main)");for(let n=0;n<e.length;n++)e[n].remove(e[n])}(),window.elements.mainPin.style.left=window.constants.PIN_LEFT_COORD+"px",window.elements.mainPin.style.top=window.constants.PIN_TOP_COORD+"px",window.util.setAddress(),document.removeEventListener("keydown",window.showCard.onEscRemoveAdvert),window.elements.mapSection.removeEventListener("click",window.showCard.onPinClick),window.elements.filterForm.removeEventListener("change",window.filter.onMapFormChange),window.elements.mainPin.addEventListener("mouseup",window.map.onButtonMouseUp)};c.addEventListener("click",I)})(),window.util={getUnique(e){const n=e[this.getRandom(0,e.length)];return e.splice(e.indexOf(n),1),n},getRandom:(e,n)=>Math.floor(Math.random()*(n-e))+e,shuffleArray(e){const n=e.slice();for(let e=0;e<n.length;e++){let t=Math.floor(Math.random()*(e+1)),o=n[e];n[e]=n[t],n[t]=o}return n},toggleDisabled(e,n){for(let t=0;t<n.length;t++)n[t].disabled=e},setAddress(){window.elements.inputAddress.setAttribute("value",`${parseInt(window.elements.mainPin.style.left,10)}, ${parseInt(window.elements.mainPin.style.top,10)}`)}},window.pin={visible:[],createPins(e){e.forEach((function(e,n){const t=window.elements.pinTemplate.cloneNode(!0);t.children[0].src=e.author.avatar,t.dataset.id=n,t.style.left=Math.floor(e.location.x-window.constants.PIN_WIDTH/2)+"px",t.style.top=e.location.y+"px",t.children[0].alt=e.offer.title,window.pin.visible.push(t),window.elements.fragmentPins.appendChild(t)})),window.elements.mapPinList.appendChild(window.elements.fragmentPins)}},(()=>{const e=window.elements.mapPinList.offsetWidth,n=window.elements.errorTemplate.cloneNode(!0),t=n.querySelector(".error__button"),o=n.querySelector(".error__message");window.elements.mainPin.addEventListener("mousedown",(function(n){n.preventDefault();let t={x:n.clientX,y:n.clientY};const o=function(n){n.preventDefault();const o=t.x-n.clientX,i=t.y-n.clientY;t={x:n.clientX,y:n.clientY};const s=window.constants.PIN_WIDTH/2+window.elements.mainPin.offsetLeft,d=window.constants.PIN_HEIGHT+window.constants.PIN_ARROW_HEIGHT+window.elements.mainPin.offsetTop,r=window.elements.mainPin.offsetLeft-o,a=window.elements.mainPin.offsetTop-i;r<0?window.elements.mainPin.style.left="0px":r>e-window.constants.PIN_WIDTH?window.elements.mainPin.style.left=e-window.constants.PIN_WIDTH+"px":window.elements.mainPin.style.left=r+"px",a>window.constants.MAX_LOCATION_Y?window.elements.mainPin.style.top=window.constants.MAX_LOCATION_Y+"px":a<window.constants.MIN_LOCATION_Y?window.elements.mainPin.style.top=window.constants.MIN_LOCATION_Y+"px":window.elements.mainPin.style.top=a+"px",window.elements.mapSection.classList.contains("map--faded")||window.elements.inputAddress.setAttribute("value",`${Math.floor(s)}, ${Math.floor(d)}`)},i=function(e){e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)})),window.map={onButtonMouseUp(){window.backend.load((function(e){window.adverts=e,window.filteredPins=window.util.shuffleArray(e).splice(0,window.constants.MAX_QUANTITY_PINS),window.pin.createPins(window.filteredPins)}),l),window.elements.mapSection.classList.remove("map--faded"),window.elements.advertForm.classList.remove("ad-form--disabled"),window.util.toggleDisabled(!1,window.elements.fieldsets),window.util.toggleDisabled(!1,window.elements.filterSelects),i(),window.util.setAddress(),window.elements.filterForm.addEventListener("change",window.filter.onMapFormChange),window.elements.mapSection.addEventListener("click",window.showCard.onPinClick),window.elements.filterForm.addEventListener("change",window.filter.onMapFormChange)}};const i=function(){window.elements.mainPin.removeEventListener("mouseup",window.map.onButtonMouseUp)},s=function(e){e.keyCode===window.constants.ESC_KEYCODE&&a()},d=function(e){e.keyCode===window.constants.ENTER_KEYCODE&&a()},r=function(){a()},a=function(){window.elements.mapSection.removeChild(n),t.removeEventListener("keyup",d),document.removeEventListener("keyup",s),document.removeEventListener("click",r)},l=function(e){o.textContent=e,t.setAttribute("tabindex","0"),t.addEventListener("keyup",d),document.addEventListener("keyup",s),document.addEventListener("click",r),window.elements.mapSection.appendChild(n)};window.util.toggleDisabled(!0,window.elements.fieldsets),window.util.toggleDisabled(!0,window.elements.filterSelects),window.util.setAddress(),window.elements.mainPin.addEventListener("mouseup",window.map.onButtonMouseUp)})(),window.getCardData=function(e){const n=window.elements.cardTemplate.cloneNode(!0),t=e.offer.rooms,o=e.offer.guests;let i=" комнат для ";const s=o===window.constants.MIN_GUESTS?" гостя":" гостей";t===window.constants.MIN_ROOM?i=" комната для ":t>window.constants.MIN_ROOM&&t<window.constants.MAX_ROOM&&(i=" комнаты для "),n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+" ₽/ночь",n.querySelector(".popup__type").textContent=window.constants.TypesOfHouses[e.offer.type].translate,n.querySelector(".popup__text--capacity").textContent=`${t}${i} для ${o}${s}`,n.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin} выезд после ${e.offer.checkout}`;const d=n.querySelector(".popup__features");d.innerHTML="",d.appendChild(function(e){const n=document.createDocumentFragment();for(let t=0;t<e.length;t++){const o=document.createElement("li");o.classList.add("popup__feature");const i="popup__feature--"+e[t];o.classList.add(i),n.appendChild(o)}return n}(e.offer.features)),n.querySelector(".popup__description").textContent=e.offer.description;const r=n.querySelector(".popup__photos");return r.innerHTML="",r.appendChild(function(e){const n=document.createDocumentFragment();for(let t=0;t<e.length;t++){const o=document.createElement("img");o.src=e[t],o.width=window.constants.AVATAR_WIDTH,o.height=window.constants.AVATAR_HEIGHT,o.classList.add("popup__photo"),n.appendChild(o)}return n}(e.offer.photos)),n.querySelector(".popup__avatar").src=e.author.avatar,n},(()=>{let e=null;const n=function(){window.showCard.currentAdvert&&(window.elements.mapSection.removeChild(window.showCard.currentAdvert),window.showCard.currentAdvert=null)},t=function(o){o.keyCode===window.constants.ESC_KEYCODE&&(n(),document.removeEventListener("keydown",t),e.classList.remove(window.constants.MAP_PIN_ACTIVE_CLASS),window.showCard.activeAdvert=null,e.blur())},o=function(){n(),e&&(e.classList.remove(window.constants.MAP_PIN_ACTIVE_CLASS),window.showCard.activeAdvert=null)};window.showCard={closeOpenedAdvert(e){e&&(window.showCard.activeAdvert=null,window.showCard.currentAdvert=null,window.elements.mapSection.removeChild(e))},activeAdvert:null,onPinClick:function(n){const i=n.target,s=i.closest(".map__pin:not(.map__pin--main)");var d;"popup__close"===i.className&&(o(),document.removeEventListener("keydown",t)),s&&window.showCard.activeAdvert!==s.dataset.id&&(o(),e=s,d=s.dataset.id,window.showCard.activeAdvert=d,window.showCard.currentAdvert=window.elements.mapSection.appendChild(window.getCardData(window.filteredPins[d])),document.addEventListener("keydown",t),s.classList.add(window.constants.MAP_PIN_ACTIVE_CLASS))},onEscRemoveAdvert:t}})()})();